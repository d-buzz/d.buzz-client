version: 2.1

orbs:
  discord: antonioned/discord@0.1.0

jobs:
  prod_build_test:
      docker:
        - image: node:14.7.0
      working_directory: /tmp/dbuzz-client
      steps:
        - checkout
        - run: npm install
        - run: npm run lint
        - run: npm run build:prod
        - discord/status:
            webhook: https://discordapp.com/api/webhooks/747082285828014170/6TLGC1_wgAAT91n5s3PYZxC9n2_Tj5BzqHQo2tO9miZxnVGKWusD3YA-pO2GjVvOWzuF

  dev_build_test:
      docker:
        - image: node:14.7.0
      working_directory: /tmp/dbuzz-client
      steps:
        - checkout
        - run: npm install
        - run: npm run lint
        - run: npm run build:dev
        - discord/status:
            webhook: https://discordapp.com/api/webhooks/747082285828014170/6TLGC1_wgAAT91n5s3PYZxC9n2_Tj5BzqHQo2tO9miZxnVGKWusD3YA-pO2GjVvOWzuF

  dev_build_deploy:
      machine:
        enabled: true
      steps:
        - run:
            name: Deploy over SSH
            command: ssh ubuntu@51.75.93.8 'sudo rm -R dbuzz-dev-build/ && git clone -b dev git@github.com:d-buzz/d.buzz-client.git dbuzz-dev-build && cd dbuzz-dev-build/  && sudo docker-compose -f docker-compose.dev.yml up -d --build'

workflows:
  environment_builds:
    jobs:
      - dev_build_test:
          filters:
            branches:
              ignore: master
      - prod_build_test:
          filters:
            branches:
              only: master
      - dev_build_deploy:
          requires:
            - dev_build_test
          filters:
            branches:
              only: dev
